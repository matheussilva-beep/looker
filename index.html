<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pilot – rastreamento com login + GA4</title>
  <style>
    body{margin:0;font:14px system-ui;background:#0b0d12;color:#e7ecff;display:flex;align-items:center;justify-content:center;height:100vh}
    header{padding:10px 12px;border-bottom:1px solid #1b2140}
    small{opacity:.8}
    #s{font-size:12px;opacity:.8}
    iframe{width:100%;height:calc(100vh - 56px);border:0}
    .hidden{display:none}
    .login-box{background:#12182e;padding:20px;border-radius:10px;max-width:340px;width:100%;box-sizing:border-box}
    input{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #1b2140;background:#0b0d12;color:#fff}
    button{width:100%;padding:10px;background:#2563eb;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold}
  </style>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QPLM3ZCYPR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-QPLM3ZCYPR'); // ID do seu GA4
  </script>
</head>
<body>
  <div id="login" class="login-box">
    <h3>Identifique-se</h3>
    <p style="font-size:13px;opacity:.8">Informe seu nome e e-mail para acessar o relatório.</p>
    <input type="text" id="name" placeholder="Seu nome" autocomplete="name">
    <input type="email" id="email" placeholder="voce@empresa.com" autocomplete="email">
    <button id="enter">Acessar relatório</button>
    <div id="err" style="color:#ffb4b4;font-size:12px;white-space:pre-line"></div>
  </div>

  <div id="reportArea" class="hidden" style="flex:1;flex-direction:column;width:100%">
    <header>
      <div><b>Demo</b> · <small>GitHub Pages ➜ Looker Studio</small></div>
      <div id="s">status: —</div>
    </header>
    <iframe id="r" allowfullscreen loading="lazy"></iframe>
  </div>

  <script>
  // ======= CONFIG =======
  const REPORT_URL   = 'https://lookerstudio.google.com/embed/reporting/7a30f5e7-ced7-43b3-95ca-01048971b397/page/6JNhC';
  const LOG_ENDPOINT = 'https://script.google.com/a/macros/pmweb.com.br/s/AKfycbz1s-MzHpOGVhwGgg50Gnk_lV59_yE0f8qKNmUVrtL4ktks6nVhbHAqpcif0px_B6KnLQ/exec';
  // ======================

  let sessionId, user, email, start;
  const setStatus = t => document.getElementById('s').textContent = t;
  const setError  = t => document.getElementById('err').textContent = t || '';

  // (Opcional) hash SHA-256 se quiser mandar hash para o GA4 no lugar do e-mail puro
  async function sha256Hex(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str.trim().toLowerCase()));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  // Envia para Sheets e GA4
  async function log(event, extra = {}) {
    // envia para Apps Script (Sheets)
    const payload = {
      event,
      ts: new Date().toISOString(),
      sessionId,
      user,
      email,
      pageUrl: location.href,
      reportUrl: REPORT_URL,
      ua: navigator.userAgent,
      ref: document.referrer,
      ...extra
    };

    try {
      const res = await fetch(LOG_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain; charset=UTF-8' }, // evita preflight
        body: JSON.stringify(payload)
      });
      setStatus(res.ok ? 'status: online' : 'status: erro');
    } catch {
      setStatus('status: falhou');
    }

    // envia para GA4
    gtag('event', event, {
      session_id: sessionId,
      user_name: user,
      // Se você quiser usar hash no GA4, envie user_id e/ou user_email como hash:
      ...(extra.email_hash ? { user_id: extra.email_hash, user_email: extra.email_hash } : {})
      // Se quiser e-mail puro no GA4 (vai virar (redacted)), troque por:
      // user_id: email, user_email: email
    });
  }

  document.getElementById('enter').onclick = async () => {
    setError('');
    const nameVal = document.getElementById('name').value.trim();
    const emailVal = document.getElementById('email').value.trim();
    if (!nameVal || !emailVal) { setError('Preencha nome e e-mail para continuar'); return; }

    user = nameVal;
    email = emailVal;
    sessionId = crypto.randomUUID?.() || Math.random().toString(36).slice(2);
    start = Date.now();

    // Se quiser GA4 com hash do e-mail:
    const emailHash = await sha256Hex(emailVal);
    gtag('config', 'G-QPLM3ZCYPR', { user_id: emailHash });
    gtag('set', 'user_properties', { user_email: emailHash, user_name: user });

    // Libera o relatório
    document.getElementById('login').classList.add('hidden');
    document.getElementById('reportArea').classList.remove('hidden');
    document.getElementById('r').src = REPORT_URL;

    // Eventos
    log('page_view', { email_hash: emailHash });
    window.addEventListener('beforeunload', () => {
      const durationSec = Math.round((Date.now() - start) / 1000);
      const unloadData = { event:'page_unload', sessionId, user, email, email_hash: emailHash, pageUrl: location.href, reportUrl: REPORT_URL, durationSec };
      navigator.sendBeacon(LOG_ENDPOINT, new Blob([JSON.stringify(unloadData)], { type: 'text/plain' }));
      gtag('event', 'page_unload', unloadData);
    });
    setInterval(() => {
      log('heartbeat', { aliveFor: Math.round((Date.now() - start) / 1000), email_hash: emailHash });
    }, 15000);
  };
  </script>

  <!-- Dicas GA4:
     - Crie dimensão personalizada (Event) para 'user_email' ou 'user_email_hash' se usar como parâmetro de evento.
     - Como o código acima usa hash, use 'user_id' = hash e 'user_email' (user_property) = hash.
  -->
</body>
</html>
